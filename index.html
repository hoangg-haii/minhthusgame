<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minh Th∆∞'s Game - l·ªói th√¨ feedback=))</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap');

        body {
            font-family: 'Quicksand', sans-serif;
            background: #fff1f2;
            overflow: hidden;
            touch-action: manipulation;
        }

        .game-container {
            max-width: 500px;
            margin: 0 auto;
            position: relative;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .board-wrapper {
            position: relative;
            flex-grow: 1;
            margin: 15px;
            padding: 15px;
            background: #ffe4e6;
            border: 8px solid #fecdd3;
            border-radius: 30px;
            box-shadow: 0 10px 25px rgba(225, 29, 72, 0.1);
            overflow: hidden;
        }

        #game-board {
            position: relative;
            width: 100%;
            height: 100%;
            background: #fff5f5;
            border-radius: 20px;
            overflow: hidden;
        }

        .item {
            position: absolute;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            user-select: none;
            border: 3px solid #fb7185;
        }

        /* Tr·∫°ng th√°i b·ªã kh√≥a (l·ªõp d∆∞·ªõi) */
        .item.locked {
            filter: brightness(0.5) grayscale(1);
            cursor: not-allowed;
            opacity: 0.7;
            border-color: #94a3b8;
            transform: scale(0.95);
        }

        .item.selected {
            background: #fff1f2;
            border-color: #e11d48;
            box-shadow: 0 0 20px #fb7185;
            transform: scale(1.1) rotate(5deg) !important;
            z-index: 100 !important;
        }

        .item.hint {
            animation: pulse 0.6s infinite alternate;
            border-color: #fbbf24;
            background: #fffbeb;
        }

        @keyframes pulse {
            from { transform: scale(1); box-shadow: 0 0 0px #fbbf24; }
            to { transform: scale(1.1); box-shadow: 0 0 15px #fbbf24; }
        }

        .progress-bar {
            height: 16px;
            background: #f1f5f9;
            border-radius: 20px;
            border: 3px solid #fda4af;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #fb7185, #f43f5e);
            width: 100%;
            transition: width 0.2s ease-out;
        }

        .floating-score {
            position: absolute;
            color: #e11d48;
            font-weight: bold;
            font-size: 24px;
            pointer-events: none;
            animation: floatUp 0.7s ease-out forwards;
            z-index: 200;
        }

        @keyframes floatUp {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-70px); }
        }

        .modal {
            background: rgba(76, 5, 25, 0.5);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>

    <div class="game-container">
        <!-- Header -->
        <div class="p-4 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-black text-pink-600">Cute Match</h1>
                <p class="text-xs font-bold text-pink-400 uppercase tracking-widest">C·∫•p ƒë·ªô: <span id="current-level" class="text-pink-600">1</span></p>
            </div>
            <div class="text-right">
                <p class="text-3xl font-black text-pink-600" id="score">0</p>
                <p class="text-[10px] font-bold text-gray-400 uppercase">T·ªïng ƒëi·ªÉm</p>
            </div>
        </div>

        <!-- Timer -->
        <div class="px-6 mb-4">
            <div class="progress-bar">
                <div id="timer-fill" class="progress-fill"></div>
            </div>
        </div>

        <!-- Game Board (Khung bao) -->
        <div class="board-wrapper">
            <div id="game-board"></div>
        </div>

        <!-- Controls -->
        <div class="p-6 flex gap-4">
            <button onclick="useHint()" class="flex-1 bg-amber-400 hover:bg-amber-500 text-white py-4 rounded-2xl font-black shadow-[0_5px_0_#d97706] active:translate-y-1 active:shadow-none transition-all">
                G·ª¢I √ù
            </button>
            <button onclick="shuffleBoard()" class="flex-1 bg-rose-400 hover:bg-rose-500 text-white py-4 rounded-2xl font-black shadow-[0_5px_0_#e11d48] active:translate-y-1 active:shadow-none transition-all">
                X√ÅO B√ÄI
            </button>
        </div>
    </div>

    <!-- Modals -->
    <div id="game-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-[200]">
        <div class="bg-white p-8 rounded-[40px] text-center max-w-xs w-full shadow-2xl border-4 border-pink-100 mx-4">
            <h2 id="modal-title" class="text-3xl font-black text-pink-600 mb-2">Th·∫Øng r·ªìi!</h2>
            <p id="modal-desc" class="text-gray-500 font-medium mb-6">B·∫°n th·∫≠t xu·∫•t s·∫Øc.</p>
            <button id="modal-btn" class="bg-pink-500 hover:bg-pink-600 text-white w-full py-4 rounded-2xl font-black text-xl shadow-lg active:scale-95 transition-transform">TI·∫æP T·ª§C</button>
        </div>
    </div>

    <script>
        const emojis = ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üêî', 'üêß', 'üê¶', 'üê§', 'ü¶Ü'];
        const board = document.getElementById('game-board');
        const scoreEl = document.getElementById('score');
        const levelEl = document.getElementById('current-level');
        const timerFill = document.getElementById('timer-fill');
        
        let state = {
            score: 0,
            level: 1,
            timeLeft: 60,
            maxTime: 60,
            items: [],
            selected: null,
            timer: null,
            isGameOver: false
        };

        const playSound = (type) => {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            if (type === 'match') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(500, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1);
            } else if (type === 'error') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(150, ctx.currentTime);
            }
            gain.gain.setValueAtTime(0.05, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
            osc.start();
            osc.stop(ctx.currentTime + 0.2);
        };

        function initLevel() {
            state.isGameOver = false;
            state.items = [];
            state.selected = null;
            state.timeLeft = Math.max(30, 85 - (state.level * 5));
            state.maxTime = state.timeLeft;
            board.innerHTML = '';
            levelEl.innerText = state.level;
            
            // S·ªë l∆∞·ª£ng c·∫∑p v·∫≠t ph·∫©m m·ªói m√†n
            const pairsPerLevel = 6 + (state.level * 2);
            const layersCount = Math.min(6, 2 + Math.floor(state.level / 2));
            
            const padding = 10;
            const itemW = 60;
            const itemH = 60;
            const maxW = board.clientWidth - itemW - padding;
            const maxH = board.clientHeight - itemH - padding;

            // Thu·∫≠t to√°n: Ph√¢n ph·ªëi c√°c c·∫∑p v·∫≠t ph·∫©m v√†o t·ª´ng l·ªõp ƒë·ªÉ ƒë·∫£m b·∫£o m·ªói l·ªõp lu√¥n x√≥a ƒë∆∞·ª£c
            let totalPairsAdded = 0;
            for(let l = 0; l < layersCount; l++) {
                // X√°c ƒë·ªãnh s·ªë l∆∞·ª£ng c·∫∑p cho l·ªõp n√†y (ƒë·∫£m b·∫£o t·ªïng c√°c c·∫∑p kh·ªõp v·ªõi pairsPerLevel)
                let pairsInThisLayer;
                if (l === layersCount - 1) {
                    pairsInThisLayer = pairsPerLevel - totalPairsAdded;
                } else {
                    pairsInThisLayer = Math.max(2, Math.floor(pairsPerLevel / layersCount));
                }
                totalPairsAdded += pairsInThisLayer;

                for (let p = 0; p < pairsInThisLayer; p++) {
                    const emoji = emojis[Math.floor(Math.random() * emojis.length)];
                    // Th√™m 2 v·∫≠t ph·∫©m (1 c·∫∑p) v√†o c√πng m·ªôt l·ªõp
                    for (let i = 0; i < 2; i++) {
                        state.items.push({
                            id: Math.random().toString(36).substr(2, 9),
                            emoji: emoji,
                            layer: l,
                            x: padding + Math.random() * maxW,
                            y: padding + Math.random() * maxH,
                            removed: false
                        });
                    }
                }
            }

            renderBoard();
            startTimer();
        }

        function renderBoard() {
            board.innerHTML = '';
            const activeLayer = getActiveLayer();

            // S·∫Øp x·∫øp render: Layer l·ªõn (d∆∞·ªõi) v·∫Ω tr∆∞·ªõc, Layer nh·ªè (tr√™n) v·∫Ω sau
            const sorted = [...state.items].filter(i => !i.removed).sort((a,b) => b.layer - a.layer);
            
            sorted.forEach(item => {
                const el = document.createElement('div');
                el.className = `item`;
                el.innerText = item.emoji;
                el.style.left = item.x + 'px';
                el.style.top = item.y + 'px';
                el.style.zIndex = 100 - item.layer; 
                
                if(item.layer !== activeLayer) {
                    el.classList.add('locked');
                }
                
                if(state.selected && state.selected.id === item.id) {
                    el.classList.add('selected');
                }

                el.onclick = () => handleItemClick(item, activeLayer);
                board.appendChild(el);
            });

            if(state.items.every(i => i.removed)) winGame();
        }

        function getActiveLayer() {
            const remaining = state.items.filter(i => !i.removed);
            if(remaining.length === 0) return -1;
            // Tr·∫£ v·ªÅ l·ªõp nh·ªè nh·∫•t hi·ªán c√≥ (L·ªõp ƒëang ƒë∆∞·ª£c ∆∞u ti√™n gi·∫£i quy·∫øt)
            return Math.min(...remaining.map(i => i.layer));
        }

        function handleItemClick(item, activeLayer) {
            if(state.isGameOver || item.removed || item.layer !== activeLayer) return;

            if(state.selected && state.selected.id === item.id) {
                state.selected = null;
                renderBoard();
                return;
            }

            if(!state.selected) {
                state.selected = item;
                renderBoard();
            } else {
                if(state.selected.emoji === item.emoji) {
                    matchItems(state.selected, item);
                } else {
                    playSound('error');
                    state.selected = null;
                    renderBoard();
                }
            }
        }

        function matchItems(item1, item2) {
            item1.removed = true;
            item2.removed = true;
            state.selected = null;
            state.score += 10;
            scoreEl.innerText = state.score;
            playSound('match');
            showFloatingScore(item2.x, item2.y);
            renderBoard();
        }

        function showFloatingScore(x, y) {
            const el = document.createElement('div');
            el.className = 'floating-score';
            el.innerText = '+10';
            el.style.left = (x + 10) + 'px';
            el.style.top = y + 'px';
            board.appendChild(el);
            setTimeout(() => el.remove(), 700);
        }

        function startTimer() {
            clearInterval(state.timer);
            state.timer = setInterval(() => {
                state.timeLeft -= 0.1;
                const percent = (state.timeLeft / state.maxTime) * 100;
                timerFill.style.width = percent + '%';
                if(state.timeLeft <= 0) gameOver();
            }, 100);
        }

        function useHint() {
            const activeLayer = getActiveLayer();
            const activeItems = state.items.filter(i => !i.removed && i.layer === activeLayer);
            for(let i=0; i<activeItems.length; i++) {
                for(let j=i+1; j<activeItems.length; j++) {
                    if(activeItems[i].emoji === activeItems[j].emoji) {
                        const els = document.querySelectorAll('.item:not(.locked)');
                        els.forEach(el => {
                            if(el.innerText === activeItems[i].emoji) {
                                el.classList.add('hint');
                                setTimeout(() => el.classList.remove('hint'), 1200);
                            }
                        });
                        return;
                    }
                }
            }
        }

        function shuffleBoard() {
            const activeLayer = getActiveLayer();
            const remainingInLayer = state.items.filter(i => !i.removed && i.layer === activeLayer);
            // L·∫•y danh s√°ch emoji hi·ªán t·∫°i trong l·ªõp v√† x√°o tr·ªôn
            const emojisRem = remainingInLayer.map(i => i.emoji).sort(() => Math.random() - 0.5);
            let idx = 0;
            state.items.forEach(i => {
                if(!i.removed && i.layer === activeLayer) i.emoji = emojisRem[idx++];
            });
            renderBoard();
        }

        function winGame() {
            clearInterval(state.timer);
            state.isGameOver = true;
            showModal("Ho√†n th√†nh!", `V∆∞·ª£t qua M√†n ${state.level} th√†nh c√¥ng!`, () => {
                state.level++;
                initLevel();
                hideModal();
            });
        }

        function gameOver() {
            clearInterval(state.timer);
            state.isGameOver = true;
            showModal("H·∫øt gi·ªù!", "C·ªë g·∫Øng h∆°n ·ªü l·∫ßn sau nh√©!", () => {
                state.score = 0;
                scoreEl.innerText = "0";
                state.level = 1;
                initLevel();
                hideModal();
            });
        }

        function showModal(title, desc, btnAction) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-desc').innerText = desc;
            const btn = document.getElementById('modal-btn');
            btn.onclick = btnAction;
            document.getElementById('game-modal').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('game-modal').classList.add('hidden');
        }

        window.onload = initLevel;
    </script>
</body>
</html>
