<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tripple 3 - game cho vợ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Thêm thư viện Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap');

        :root {
            --pink-pastel-light: #fdf2f8;
            --pink-pastel: #fbcfe8;
            --pink-pastel-dark: #f472b6;
            --blue-pastel-light: #f0f9ff;
            --blue-pastel: #bae6fd;
            --blue-pastel-dark: #38bdf8;
        }

        body {
            font-family: 'Quicksand', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--pink-pastel-light);
            overflow: hidden;
            touch-action: manipulation;
        }

        .game-container {
            max-width: 500px;
            margin: 0 auto;
            position: relative;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .board-wrapper {
            position: relative;
            flex-grow: 1;
            margin: 10px;
            padding: 10px;
            background: var(--blue-pastel-light);
            border: 6px solid var(--blue-pastel);
            border-radius: 24px;
            box-shadow: 0 8px 20px rgba(56, 189, 248, 0.1);
            overflow: hidden;
        }

        #game-board {
            position: relative;
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 16px;
            overflow: hidden;
        }

        .item {
            position: absolute;
            width: 54px;
            height: 54px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), filter 0.3s;
            user-select: none;
            border: 2px solid var(--pink-pastel);
            color: var(--pink-pastel-dark);
        }

        .item.locked {
            filter: brightness(0.8) grayscale(0.5);
            cursor: not-allowed;
            opacity: 0.6;
            border-color: #e2e8f0;
            color: #94a3b8;
        }

        .dock-container {
            height: 80px;
            background: var(--pink-pastel);
            margin: 10px 15px 20px 15px;
            border-radius: 16px;
            border: 4px solid white;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 0 10px;
            gap: 6px;
            position: relative;
            box-shadow: 0 4px 10px rgba(244, 114, 182, 0.2);
        }

        .dock-slot {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            color: var(--pink-pastel-dark);
        }

        .progress-bar {
            height: 12px;
            background: white;
            border-radius: 20px;
            border: 2px solid var(--blue-pastel);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--blue-pastel), var(--blue-pastel-dark));
            width: 100%;
            transition: width 0.2s ease-out;
        }

        .modal {
            background: rgba(15, 23, 42, 0.3);
            backdrop-filter: blur(6px);
        }

        .flying-item {
            position: fixed;
            z-index: 1000;
            pointer-events: none;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            border-radius: 12px;
            border: 2px solid var(--pink-pastel);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            color: var(--pink-pastel-dark);
        }

        .settings-btn:hover i {
            transform: rotate(90deg);
        }
        .settings-btn i {
            transition: transform 0.5s ease;
        }

        .btn-shadow-blue {
            box-shadow: 0 4px 0 #7dd3fc;
        }
        .btn-shadow-pink {
            box-shadow: 0 4px 0 #f9a8d4;
        }
    </style>
</head>
<body>

    <div class="game-container">
        <!-- Header -->
        <div class="p-4 flex justify-between items-center relative">
            <div>
                <h1 class="text-xl font-black text-blue-400 uppercase leading-none">Tripple 3</h1>
                <p class="text-[10px] font-bold text-pink-400 uppercase tracking-widest">game cho vợ</p>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <p class="text-2xl font-black text-blue-400 leading-none" id="score">0</p>
                    <p class="text-[10px] font-bold text-gray-400 uppercase">Cấp: <span id="current-level">1</span></p>
                </div>
                <button onclick="toggleSettings(true)" class="settings-btn w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center text-blue-300 border-2 border-blue-50 active:scale-90 transition-transform">
                    <i data-lucide="settings" class="w-6 h-6"></i>
                </button>
            </div>
        </div>

        <!-- Timer -->
        <div class="px-6 mb-2">
            <div class="progress-bar">
                <div id="timer-fill" class="progress-fill"></div>
            </div>
        </div>

        <!-- Game Board -->
        <div class="board-wrapper">
            <div id="game-board"></div>
        </div>

        <!-- Dock -->
        <div class="dock-container" id="dock"></div>

        <!-- Controls -->
        <div class="p-4 flex gap-3">
            <button onclick="useHint()" class="flex-1 bg-sky-200 hover:bg-sky-300 text-sky-700 py-3 rounded-xl font-black btn-shadow-blue active:translate-y-1 active:shadow-none transition-all text-sm uppercase">
                Gợi ý
            </button>
            <button onclick="shuffleBoard()" class="flex-1 bg-pink-200 hover:bg-pink-300 text-pink-700 py-3 rounded-xl font-black btn-shadow-pink active:translate-y-1 active:shadow-none transition-all text-sm uppercase">
                Xáo bài
            </button>
        </div>
    </div>

    <!-- Modals -->
    <div id="game-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-[200]">
        <div class="bg-white p-8 rounded-[32px] text-center max-w-xs w-full shadow-2xl border-4 border-blue-50 mx-4">
            <h2 id="modal-title" class="text-2xl font-black text-blue-400 mb-2">Thắng rồi!</h2>
            <p id="modal-desc" class="text-gray-400 font-medium mb-6">Bạn thật xuất sắc.</p>
            <button id="modal-btn" class="bg-sky-400 hover:bg-sky-500 text-white w-full py-4 rounded-xl font-black text-lg shadow-lg active:scale-95 transition-transform uppercase">Tiếp tục</button>
        </div>
    </div>

    <div id="settings-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-[300]">
        <div class="bg-white p-8 rounded-[32px] text-center max-w-xs w-full shadow-2xl border-4 border-pink-50 mx-4 relative">
            <button onclick="toggleSettings(false)" class="absolute top-4 right-4 text-gray-300 hover:text-gray-500">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <div class="w-16 h-16 bg-pink-50 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="heart" class="w-8 h-8 text-pink-300 fill-current"></i>
            </div>
            <h2 class="text-xl font-black text-gray-600 mb-4 italic">game duii hôngg</h2>
            <a href="https://www.facebook.com/mt.hoanghai/" target="_blank" class="block w-full bg-sky-400 hover:bg-sky-500 text-white py-4 rounded-xl font-black text-lg shadow-lg active:scale-95 transition-transform mb-2">
                NHẤN VÀO ĐÂY NÈ
            </a>
            <p class="text-[10px] text-gray-300 uppercase font-bold mt-4 tracking-tighter">Tripple 3 v1.0 - Made with Love</p>
        </div>
    </div>

    <script>
        const iconList = [
            'heart', 'star', 'cherry', 'apple', 'ghost', 'cloud', 
            'moon', 'sun', 'flame', 'anchor', 'bell', 'cake', 
            'candy', 'coffee', 'fish', 'flower', 'gem', 'gift'
        ];
        
        const board = document.getElementById('game-board');
        const dockEl = document.getElementById('dock');
        const scoreEl = document.getElementById('score');
        const levelEl = document.getElementById('current-level');
        const timerFill = document.getElementById('timer-fill');
        
        const DOCK_SIZE = 7;
        
        let state = {
            score: 0,
            level: 1,
            timeLeft: 60,
            maxTime: 60,
            items: [],
            dock: [],
            timer: null,
            isGameOver: false,
            isProcessing: false
        };

        const playSound = (type) => {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                if (type === 'match') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(600, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1);
                } else if (type === 'click') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(400, ctx.currentTime);
                } else if (type === 'error') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(100, ctx.currentTime);
                }
                gain.gain.setValueAtTime(0.05, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                osc.start();
                osc.stop(ctx.currentTime + 0.2);
            } catch(e) {}
        };

        // NEW LOGIC: Sinh màn chơi đảm bảo có thể giải được theo từng lớp
        function initLevel() {
            state.isGameOver = false;
            state.isProcessing = false;
            state.items = [];
            state.dock = [];
            state.timeLeft = Math.max(45, 120 - (state.level * 5));
            state.maxTime = state.timeLeft;
            board.innerHTML = '';
            levelEl.innerText = state.level;
            renderDock();
            
            const layersCount = Math.min(6, 3 + Math.floor(state.level / 3));
            const padding = 15;
            const itemSize = 54;
            const maxW = board.clientWidth - itemSize - padding;
            const maxH = board.clientHeight - itemSize - padding;

            // Mỗi lớp sẽ có một số lượng bộ 3 nhất định
            // Điều này đảm bảo người chơi có thể xóa phần lớn lớp hiện tại để mở lớp dưới
            for(let l = 0; l < layersCount; l++) {
                // Tăng độ khó: lớp càng sâu càng nhiều icon
                const triplesInLayer = 2 + Math.floor(state.level / 2) + l; 
                
                for (let t = 0; t < triplesInLayer; t++) {
                    const icon = iconList[Math.floor(Math.random() * iconList.length)];
                    // Tạo 3 item cùng loại cho mỗi lớp
                    for (let i = 0; i < 3; i++) {
                        state.items.push({
                            id: Math.random().toString(36).substr(2, 9),
                            icon: icon,
                            layer: l,
                            // Phân bổ icon trong vùng board của lớp đó
                            x: padding + Math.random() * maxW,
                            y: padding + Math.random() * maxH,
                            removed: false
                        });
                    }
                }
            }

            renderBoard();
            startTimer();
        }

        function createIconElement(iconName, size = 28) {
            const iconWrapper = document.createElement('i');
            iconWrapper.setAttribute('data-lucide', iconName);
            iconWrapper.style.width = size + 'px';
            iconWrapper.style.height = size + 'px';
            return iconWrapper;
        }

        function renderDock() {
            dockEl.innerHTML = '';
            for (let i = 0; i < DOCK_SIZE; i++) {
                const slot = document.createElement('div');
                slot.className = 'dock-slot';
                if (state.dock[i]) {
                    const icon = createIconElement(state.dock[i], 24);
                    slot.appendChild(icon);
                    slot.style.background = "white";
                    slot.style.boxShadow = "0 2px 4px rgba(0,0,0,0.05)";
                    slot.style.border = "2px solid var(--pink-pastel)";
                }
                dockEl.appendChild(slot);
            }
            lucide.createIcons();
        }

        function renderBoard() {
            const activeLayer = getActiveLayer();
            const currentItems = state.items.filter(i => !i.removed);

            // Xóa các phần tử không còn tồn tại
            const existingEls = board.querySelectorAll('.item');
            existingEls.forEach(el => {
                if (!currentItems.find(i => i.id === el.dataset.id)) {
                    el.remove();
                }
            });

            currentItems.sort((a,b) => b.layer - a.layer).forEach(item => {
                let el = board.querySelector(`[data-id="${item.id}"]`);
                if (!el) {
                    el = document.createElement('div');
                    el.className = 'item';
                    el.dataset.id = item.id;
                    const icon = createIconElement(item.icon, 30);
                    el.appendChild(icon);
                    board.appendChild(el);
                }
                
                el.style.left = item.x + 'px';
                el.style.top = item.y + 'px';
                el.style.zIndex = 100 - item.layer;
                
                // Logic Lock: Chỉ cho bấm lớp trên cùng (layer thấp nhất)
                if(item.layer !== activeLayer) {
                    el.classList.add('locked');
                } else {
                    el.classList.remove('locked');
                }

                el.onclick = () => handleItemClick(item, activeLayer, el);
            });

            lucide.createIcons();
            if(state.items.every(i => i.removed) && state.dock.length === 0) winGame();
        }

        function getActiveLayer() {
            const remaining = state.items.filter(i => !i.removed);
            if(remaining.length === 0) return -1;
            // Lớp active là lớp có chỉ số nhỏ nhất (nằm trên cùng)
            return Math.min(...remaining.map(i => i.layer));
        }

        function handleItemClick(item, activeLayer, originalEl) {
            if(state.isGameOver || state.isProcessing || item.removed || item.layer !== activeLayer) return;
            if(state.dock.length >= DOCK_SIZE) return;

            state.isProcessing = true;
            playSound('click');

            const rect = originalEl.getBoundingClientRect();
            
            // Tìm vị trí chèn để các icon giống nhau nằm cạnh nhau trong dock
            let insertIdx = state.dock.lastIndexOf(item.icon);
            if (insertIdx === -1) insertIdx = state.dock.length;
            else insertIdx++;

            const flyer = document.createElement('div');
            flyer.className = 'flying-item';
            const flyerIcon = createIconElement(item.icon, 30);
            flyer.appendChild(flyerIcon);
            flyer.style.left = rect.left + 'px';
            flyer.style.top = rect.top + 'px';
            flyer.style.width = rect.width + 'px';
            flyer.style.height = rect.height + 'px';
            document.body.appendChild(flyer);
            lucide.createIcons();

            item.removed = true;
            originalEl.style.visibility = 'hidden';

            state.dock.splice(insertIdx, 0, item.icon);
            renderDock();

            const targetSlot = dockEl.children[insertIdx];
            const targetRect = targetSlot.getBoundingClientRect();

            requestAnimationFrame(() => {
                flyer.style.left = targetRect.left + 'px';
                flyer.style.top = targetRect.top + 'px';
                flyer.style.width = targetRect.width + 'px';
                flyer.style.height = targetRect.height + 'px';
                flyer.style.transform = 'scale(0.8)';
            });

            setTimeout(() => {
                flyer.remove();
                checkMatch3();
                renderBoard();
                renderDock();
                state.isProcessing = false;
                
                if (state.dock.length >= DOCK_SIZE) {
                    setTimeout(() => {
                        if (state.isGameOver) return;
                        gameOver("Thanh chứa đã đầy!");
                    }, 100);
                }
            }, 500);
        }

        function checkMatch3() {
            const counts = {};
            state.dock.forEach(iconName => counts[iconName] = (counts[iconName] || 0) + 1);
            
            for (let iconName in counts) {
                if (counts[iconName] >= 3) {
                    playSound('match');
                    state.score += 30;
                    scoreEl.innerText = state.score;
                    
                    let removedCount = 0;
                    state.dock = state.dock.filter(e => {
                        if (e === iconName && removedCount < 3) {
                            removedCount++;
                            return false;
                        }
                        return true;
                    });
                }
            }
        }

        function startTimer() {
            clearInterval(state.timer);
            state.timer = setInterval(() => {
                if(state.isGameOver) return;
                state.timeLeft -= 0.1;
                const percent = (state.timeLeft / state.maxTime) * 100;
                timerFill.style.width = percent + '%';
                if(state.timeLeft <= 0) gameOver("Hết thời gian!");
            }, 100);
        }

        function useHint() {
            const activeLayer = getActiveLayer();
            const activeItems = state.items.filter(i => !i.removed && i.layer === activeLayer);
            if(activeItems.length > 0) {
                const randomItem = activeItems[Math.floor(Math.random() * activeItems.length)];
                const els = document.querySelectorAll('.item:not(.locked)');
                els.forEach(el => {
                    const iconEl = el.querySelector('[data-lucide]');
                    if(iconEl && iconEl.getAttribute('data-lucide') === randomItem.icon) {
                        el.style.boxShadow = "0 0 20px #bae6fd";
                        el.style.borderColor = "#38bdf8";
                        setTimeout(() => {
                            el.style.boxShadow = "";
                            el.style.borderColor = "";
                        }, 1000);
                    }
                });
            }
        }

        function shuffleBoard() {
            const activeLayer = getActiveLayer();
            const remainingInLayer = state.items.filter(i => !i.removed && i.layer === activeLayer);
            const iconsRem = remainingInLayer.map(i => i.icon).sort(() => Math.random() - 0.5);
            let idx = 0;
            state.items.forEach(i => {
                if(!i.removed && i.layer === activeLayer) i.icon = iconsRem[idx++];
            });
            board.querySelectorAll('.item').forEach(el => el.innerHTML = '');
            renderBoard();
        }

        function winGame() {
            clearInterval(state.timer);
            state.isGameOver = true;
            showModal("Hoàn thành!", `Vượt qua Cấp độ ${state.level}!`, () => {
                state.level++;
                initLevel();
                hideModal();
            });
        }

        function gameOver(reason) {
            if (state.isGameOver) return;
            clearInterval(state.timer);
            state.isGameOver = true;
            playSound('error');
            showModal("Kết thúc!", reason, () => {
                state.score = 0;
                scoreEl.innerText = "0";
                state.level = 1;
                initLevel();
                hideModal();
            });
        }

        function showModal(title, desc, btnAction) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-desc').innerText = desc;
            const btn = document.getElementById('modal-btn');
            btn.onclick = btnAction;
            document.getElementById('game-modal').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('game-modal').classList.add('hidden');
        }

        function toggleSettings(show) {
            const modal = document.getElementById('settings-modal');
            if (show) modal.classList.remove('hidden');
            else modal.classList.add('hidden');
        }

        window.onload = () => {
            initLevel();
            lucide.createIcons();
        };
    </script>
</body>
</html>
