<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tripple 3 - game cho vợ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Thêm thư viện Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap');

        body {
            font-family: 'Quicksand', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #fff1f2;
            overflow: hidden;
            touch-action: manipulation;
        }

        .game-container {
            max-width: 500px;
            margin: 0 auto;
            position: relative;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .board-wrapper {
            position: relative;
            flex-grow: 1;
            margin: 10px;
            padding: 10px;
            background: #ffe4e6;
            border: 6px solid #fecdd3;
            border-radius: 24px;
            box-shadow: 0 8px 20px rgba(225, 29, 72, 0.1);
            overflow: hidden;
        }

        #game-board {
            position: relative;
            width: 100%;
            height: 100%;
            background: #fff5f5;
            border-radius: 16px;
            overflow: hidden;
        }

        .item {
            position: absolute;
            width: 54px;
            height: 54px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), filter 0.3s;
            user-select: none;
            border: 2px solid #fb7185;
            color: #e11d48;
        }

        .item.locked {
            filter: brightness(0.6) grayscale(1);
            cursor: not-allowed;
            opacity: 0.8;
            border-color: #94a3b8;
            color: #64748b;
        }

        .dock-container {
            height: 80px;
            background: #fda4af;
            margin: 10px 15px 20px 15px;
            border-radius: 16px;
            border: 4px solid #fb7185;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 0 10px;
            gap: 6px;
            position: relative;
        }

        .dock-slot {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            color: #e11d48;
        }

        .progress-bar {
            height: 12px;
            background: #f1f5f9;
            border-radius: 20px;
            border: 2px solid #fda4af;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #fb7185, #f43f5e);
            width: 100%;
            transition: width 0.2s ease-out;
        }

        .modal {
            background: rgba(76, 5, 25, 0.6);
            backdrop-filter: blur(8px);
        }

        .flying-item {
            position: fixed;
            z-index: 1000;
            pointer-events: none;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            border-radius: 12px;
            border: 2px solid #fb7185;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 15px rgba(0,0,0,0.2);
            color: #e11d48;
        }

        /* Nút cài đặt xoay khi hover */
        .settings-btn:hover i {
            transform: rotate(90deg);
        }
        .settings-btn i {
            transition: transform 0.5s ease;
        }
    </style>
</head>
<body>

    <div class="game-container">
        <!-- Header -->
        <div class="p-4 flex justify-between items-center relative">
            <div>
                <h1 class="text-xl font-black text-pink-600 uppercase leading-none">Tripple 3</h1>
                <p class="text-[10px] font-bold text-pink-400 uppercase tracking-widest">game cho vợ</p>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <p class="text-2xl font-black text-pink-600 leading-none" id="score">0</p>
                    <p class="text-[10px] font-bold text-gray-400 uppercase">Cấp: <span id="current-level">1</span></p>
                </div>
                <!-- Nút Cài Đặt -->
                <button onclick="toggleSettings(true)" class="settings-btn w-10 h-10 bg-white rounded-full shadow-md flex items-center justify-center text-pink-500 border-2 border-pink-100 active:scale-90 transition-transform">
                    <i data-lucide="settings" class="w-6 h-6"></i>
                </button>
            </div>
        </div>

        <!-- Timer -->
        <div class="px-6 mb-2">
            <div class="progress-bar">
                <div id="timer-fill" class="progress-fill"></div>
            </div>
        </div>

        <!-- Game Board -->
        <div class="board-wrapper">
            <div id="game-board"></div>
        </div>

        <!-- Dock (Thanh chứa) -->
        <div class="dock-container" id="dock"></div>

        <!-- Controls -->
        <div class="p-4 flex gap-3">
            <button onclick="useHint()" class="flex-1 bg-amber-400 hover:bg-amber-500 text-white py-3 rounded-xl font-black shadow-[0_4px_0_#d97706] active:translate-y-1 active:shadow-none transition-all text-sm">
                GỢI Ý
            </button>
            <button onclick="shuffleBoard()" class="flex-1 bg-rose-400 hover:bg-rose-500 text-white py-3 rounded-xl font-black shadow-[0_4px_0_#e11d48] active:translate-y-1 active:shadow-none transition-all text-sm">
                XÁO BÀI
            </button>
        </div>
    </div>

    <!-- Modal Kết Thúc / Thắng -->
    <div id="game-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-[200]">
        <div class="bg-white p-8 rounded-[32px] text-center max-w-xs w-full shadow-2xl border-4 border-pink-100 mx-4">
            <h2 id="modal-title" class="text-2xl font-black text-pink-600 mb-2">Thắng rồi!</h2>
            <p id="modal-desc" class="text-gray-500 font-medium mb-6">Bạn thật xuất sắc.</p>
            <button id="modal-btn" class="bg-pink-500 hover:bg-pink-600 text-white w-full py-4 rounded-xl font-black text-lg shadow-lg active:scale-95 transition-transform uppercase">Tiếp tục</button>
        </div>
    </div>

    <!-- Modal Cài Đặt -->
    <div id="settings-modal" class="modal fixed inset-0 hidden flex items-center justify-center z-[300]">
        <div class="bg-white p-8 rounded-[32px] text-center max-w-xs w-full shadow-2xl border-4 border-pink-100 mx-4 relative">
            <button onclick="toggleSettings(false)" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <div class="w-16 h-16 bg-pink-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="heart" class="w-8 h-8 text-pink-500 fill-current"></i>
            </div>
            <h2 class="text-xl font-black text-gray-700 mb-4 italic">game duii hôngg</h2>
            <a href="https://www.facebook.com/mt.hoanghai/" target="_blank" class="block w-full bg-blue-500 hover:bg-blue-600 text-white py-4 rounded-xl font-black text-lg shadow-lg active:scale-95 transition-transform mb-2">
                NHẤN VÀO ĐÂY NÈ
            </a>
            <p class="text-[10px] text-gray-400 uppercase font-bold mt-4">Tripple 3 v1.0 - Made with Love</p>
        </div>
    </div>

    <script>
        const iconList = [
            'heart', 'star', 'cherry', 'apple', 'ghost', 'cloud', 
            'moon', 'sun', 'flame', 'anchor', 'bell', 'cake', 
            'candy', 'coffee', 'fish', 'flower', 'gem', 'gift'
        ];
        
        const board = document.getElementById('game-board');
        const dockEl = document.getElementById('dock');
        const scoreEl = document.getElementById('score');
        const levelEl = document.getElementById('current-level');
        const timerFill = document.getElementById('timer-fill');
        
        const DOCK_SIZE = 7;
        
        let state = {
            score: 0,
            level: 1,
            timeLeft: 60,
            maxTime: 60,
            items: [],
            dock: [],
            timer: null,
            isGameOver: false,
            isProcessing: false
        };

        const playSound = (type) => {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                if (type === 'match') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(600, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1);
                } else if (type === 'click') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(400, ctx.currentTime);
                } else if (type === 'error') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(100, ctx.currentTime);
                }
                gain.gain.setValueAtTime(0.05, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                osc.start();
                osc.stop(ctx.currentTime + 0.2);
            } catch(e) {}
        };

        function initLevel() {
            state.isGameOver = false;
            state.isProcessing = false;
            state.items = [];
            state.dock = [];
            state.timeLeft = Math.max(45, 100 - (state.level * 5));
            state.maxTime = state.timeLeft;
            board.innerHTML = '';
            levelEl.innerText = state.level;
            renderDock();
            
            const totalTriples = 4 + (state.level * 2);
            const layersCount = Math.min(6, 2 + Math.floor(state.level / 2));
            
            const padding = 10;
            const itemSize = 54;
            const maxW = board.clientWidth - itemSize - padding;
            const maxH = board.clientHeight - itemSize - padding;

            let iconPool = [];
            for (let t = 0; t < totalTriples; t++) {
                const icon = iconList[Math.floor(Math.random() * iconList.length)];
                iconPool.push(icon, icon, icon);
            }
            iconPool.sort(() => Math.random() - 0.5);

            let currentPoolIdx = 0;
            for(let l = 0; l < layersCount; l++) {
                let countInLayer;
                if (l === layersCount - 1) {
                    countInLayer = iconPool.length - currentPoolIdx;
                } else {
                    const remaining = iconPool.length - currentPoolIdx;
                    countInLayer = Math.floor(Math.random() * (remaining / (layersCount - l))) + 3;
                }

                for (let i = 0; i < countInLayer && currentPoolIdx < iconPool.length; i++) {
                    state.items.push({
                        id: Math.random().toString(36).substr(2, 9),
                        icon: iconPool[currentPoolIdx++],
                        layer: l,
                        x: padding + Math.random() * maxW,
                        y: padding + Math.random() * maxH,
                        removed: false
                    });
                }
            }

            renderBoard();
            startTimer();
        }

        function createIconElement(iconName, size = 28) {
            const iconWrapper = document.createElement('i');
            iconWrapper.setAttribute('data-lucide', iconName);
            iconWrapper.style.width = size + 'px';
            iconWrapper.style.height = size + 'px';
            return iconWrapper;
        }

        function renderDock() {
            dockEl.innerHTML = '';
            for (let i = 0; i < DOCK_SIZE; i++) {
                const slot = document.createElement('div');
                slot.className = 'dock-slot';
                if (state.dock[i]) {
                    const icon = createIconElement(state.dock[i], 24);
                    slot.appendChild(icon);
                    slot.style.background = "white";
                    slot.style.boxShadow = "0 2px 4px rgba(0,0,0,0.1)";
                    slot.style.border = "2px solid #fb7185";
                }
                dockEl.appendChild(slot);
            }
            lucide.createIcons();
        }

        function renderBoard() {
            const activeLayer = getActiveLayer();
            const currentItems = state.items.filter(i => !i.removed);

            const existingEls = board.querySelectorAll('.item');
            const existingIds = Array.from(existingEls).map(el => el.dataset.id);
            
            existingIds.forEach(id => {
                if (!currentItems.find(i => i.id === id)) {
                    board.querySelector(`[data-id="${id}"]`)?.remove();
                }
            });

            currentItems.sort((a,b) => b.layer - a.layer).forEach(item => {
                let el = board.querySelector(`[data-id="${item.id}"]`);
                if (!el) {
                    el = document.createElement('div');
                    el.className = 'item';
                    el.dataset.id = item.id;
                    const icon = createIconElement(item.icon, 30);
                    el.appendChild(icon);
                    board.appendChild(el);
                }
                
                el.style.left = item.x + 'px';
                el.style.top = item.y + 'px';
                el.style.zIndex = 100 - item.layer;
                
                if(item.layer !== activeLayer) {
                    el.classList.add('locked');
                } else {
                    el.classList.remove('locked');
                }

                el.onclick = () => handleItemClick(item, activeLayer, el);
            });

            lucide.createIcons();
            if(state.items.every(i => i.removed) && state.dock.length === 0) winGame();
        }

        function getActiveLayer() {
            const remaining = state.items.filter(i => !i.removed);
            if(remaining.length === 0) return -1;
            return Math.min(...remaining.map(i => i.layer));
        }

        function handleItemClick(item, activeLayer, originalEl) {
            if(state.isGameOver || state.isProcessing || item.removed || item.layer !== activeLayer) return;
            if(state.dock.length >= DOCK_SIZE) return;

            state.isProcessing = true;
            playSound('click');

            const rect = originalEl.getBoundingClientRect();
            
            let insertIdx = state.dock.lastIndexOf(item.icon);
            if (insertIdx === -1) insertIdx = state.dock.length;
            else insertIdx++;

            const flyer = document.createElement('div');
            flyer.className = 'flying-item';
            const flyerIcon = createIconElement(item.icon, 30);
            flyer.appendChild(flyerIcon);
            flyer.style.left = rect.left + 'px';
            flyer.style.top = rect.top + 'px';
            flyer.style.width = rect.width + 'px';
            flyer.style.height = rect.height + 'px';
            document.body.appendChild(flyer);
            lucide.createIcons();

            item.removed = true;
            originalEl.style.visibility = 'hidden';

            state.dock.splice(insertIdx, 0, item.icon);
            renderDock();

            const targetSlot = dockEl.children[insertIdx];
            const targetRect = targetSlot.getBoundingClientRect();

            requestAnimationFrame(() => {
                flyer.style.left = targetRect.left + 'px';
                flyer.style.top = targetRect.top + 'px';
                flyer.style.width = targetRect.width + 'px';
                flyer.style.height = targetRect.height + 'px';
                flyer.style.transform = 'scale(0.8)';
            });

            setTimeout(() => {
                flyer.remove();
                checkMatch3();
                renderBoard();
                renderDock();
                state.isProcessing = false;
                
                if (state.dock.length >= DOCK_SIZE) {
                    setTimeout(() => {
                        if (state.isGameOver) return;
                        gameOver("Thanh chứa đã đầy!");
                    }, 100);
                }
            }, 500);
        }

        function checkMatch3() {
            const counts = {};
            state.dock.forEach(iconName => counts[iconName] = (counts[iconName] || 0) + 1);
            
            for (let iconName in counts) {
                if (counts[iconName] >= 3) {
                    playSound('match');
                    state.score += 30;
                    scoreEl.innerText = state.score;
                    
                    let removedCount = 0;
                    state.dock = state.dock.filter(e => {
                        if (e === iconName && removedCount < 3) {
                            removedCount++;
                            return false;
                        }
                        return true;
                    });
                }
            }
        }

        function startTimer() {
            clearInterval(state.timer);
            state.timer = setInterval(() => {
                if(state.isGameOver) return;
                state.timeLeft -= 0.1;
                const percent = (state.timeLeft / state.maxTime) * 100;
                timerFill.style.width = percent + '%';
                if(state.timeLeft <= 0) gameOver("Hết thời gian!");
            }, 100);
        }

        function useHint() {
            const activeLayer = getActiveLayer();
            const activeItems = state.items.filter(i => !i.removed && i.layer === activeLayer);
            if(activeItems.length > 0) {
                const randomItem = activeItems[Math.floor(Math.random() * activeItems.length)];
                const els = document.querySelectorAll('.item:not(.locked)');
                els.forEach(el => {
                    const iconEl = el.querySelector('[data-lucide]');
                    if(iconEl && iconEl.getAttribute('data-lucide') === randomItem.icon) {
                        el.style.boxShadow = "0 0 20px #fbbf24";
                        el.style.borderColor = "#fbbf24";
                        setTimeout(() => {
                            el.style.boxShadow = "";
                            el.style.borderColor = "";
                        }, 1000);
                    }
                });
            }
        }

        function shuffleBoard() {
            const activeLayer = getActiveLayer();
            const remainingInLayer = state.items.filter(i => !i.removed && i.layer === activeLayer);
            const iconsRem = remainingInLayer.map(i => i.icon).sort(() => Math.random() - 0.5);
            let idx = 0;
            state.items.forEach(i => {
                if(!i.removed && i.layer === activeLayer) i.icon = iconsRem[idx++];
            });
            board.querySelectorAll('.item').forEach(el => el.innerHTML = '');
            renderBoard();
        }

        function winGame() {
            clearInterval(state.timer);
            state.isGameOver = true;
            showModal("Hoàn thành!", `Vượt qua Cấp độ ${state.level}!`, () => {
                state.level++;
                initLevel();
                hideModal();
            });
        }

        function gameOver(reason) {
            if (state.isGameOver) return;
            clearInterval(state.timer);
            state.isGameOver = true;
            playSound('error');
            showModal("Kết thúc!", reason, () => {
                state.score = 0;
                scoreEl.innerText = "0";
                state.level = 1;
                initLevel();
                hideModal();
            });
        }

        function showModal(title, desc, btnAction) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-desc').innerText = desc;
            const btn = document.getElementById('modal-btn');
            btn.onclick = btnAction;
            document.getElementById('game-modal').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('game-modal').classList.add('hidden');
        }

        function toggleSettings(show) {
            const modal = document.getElementById('settings-modal');
            if (show) modal.classList.remove('hidden');
            else modal.classList.add('hidden');
        }

        window.onload = () => {
            initLevel();
            lucide.createIcons();
        };
    </script>
</body>
</html>
